<!DOCTYPE html>
<html>
<head>
	<title>Calculation Sheet</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
	<link rel="stylesheet" href="css/style.css">
</head>
<body>

<h1>Calculation Sheet</h1>

<div class="section">
	<button type="button" class="collapsible">Types</button>
	<div class="section-content expanded">
		<span class="empty-message">No types</span>
		<br>
		<div id="types"></div>
		<button class="plus-button" id="add-type-button">+</button>
	</div>
</div>

<div class="section">
	<button type="button" class="collapsible">Inputs</button>
	<div class="section-content">
		<div id="inputs"></div>
	</div>
</div>

<div class="section">
	<button type="button" class="collapsible">Calculations</button>
	<div class="section-content">
		<div id="calculations"></div>
	</div>
</div>

<div class="section">
	<button type="button" class="collapsible">Outputs</button>
	<div class="section-content">
		<div id="outputs"></div>
	</div>
</div>


<!--<div id="container" style="width:400px;height:30px;border:1px solid grey"></div>-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script src="node_modules/monaco-editor/min/vs/loader.js"></script>
<script src="js/main.js"></script>

<script>
	window.data = { "inputs": [], "calculations": [] };
	window.editors = {};

	function addInput(inputName, initialValue){
		window.data.inputs.push(inputName);
		let inputDiv = document.createElement("div");
		$("#inputs").append(inputDiv);
		//inputDiv.className = 'input';
		$(inputDiv).addClass('input');
		$(inputDiv).append("<span class='name'>" + inputName + "</span>");
		$(inputDiv).append("<input type='number' value=" + initialValue + ">");
	}

	function addCalculation(calculationName, initialValue) {
		window.data.calculations.push(calculationName);
		let newDiv = document.createElement("div");
		$("#calculations").append(newDiv);
		//inputDiv.className = 'input';
		$(newDiv).addClass('calculation');

		// <div class="calculation">
		// 		<div class="name">totalExpenses</div>
		// 		<div class="keyword">=</div>
		// 		<div class="expression">MyValue + 2</div>
		// 		</div>

		$(newDiv).append("<div class='name'>" + calculationName + "</div>");
		$(newDiv).append("<div class='keyword'>=</div>");
		let editorDiv = document.createElement('div');
		$(editorDiv).addClass('inline-editor');
		$(editorDiv).addClass('expression');
		$(newDiv).append(editorDiv);
		$(newDiv).append("<div class='result'>result is ...</div>");

		let editor = monaco.editor.create(editorDiv, {
			value: initialValue,
			language: 'calc',
			theme: 'myCoolTheme',

			/* No line numbers: start */
			lineNumbers: 'off',
			glyphMargin: false,
			folding: false,
			// Undocumented see https://github.com/Microsoft/vscode/issues/30795#issuecomment-410998882
			lineDecorationsWidth: 0,
			lineNumbersMinChars: 0,
			/* No line numbers: end */
			minimap: {
				enabled: false
			},
			scrollbar : {
				vertical: 'hidden',
				horizontal: 'hidden',
			}
		});
		window.editors[calculationName] = editor;
		//window.editor = editor;
		// editor.onDidChangeModelContent(function (e) {
		// 	let code = editor.getValue()
		// 	let syntaxErrors = ParserFacade.validate(code);
		// 	let monacoErrors = [];
		// 	for (let e of syntaxErrors) {
		// 		monacoErrors.push({
		// 			startLineNumber: e.startLine,
		// 			startColumn: e.startCol,
		// 			endLineNumber: e.endLine,
		// 			endColumn: e.endCol,
		// 			message: e.message,
		// 			severity: monaco.MarkerSeverity.Error
		// 		});
		// 	};
		// 	window.syntaxErrors = syntaxErrors;
		// 	let model = monaco.editor.getModels()[0];
		// 	monaco.editor.setModelMarkers(model, "owner", monacoErrors);
		// });

		let lastResizedLineCount = 0;
		let model = monaco.editor.getModels()[0];
		let editorElement = editorDiv;

		function editorUpdate() {
			let lineCount = model.getLineCount();
			// Do not invalidate layout if the line count hasn't changed, as this method
			// will be called for every keypress and layouts are too expensive.
			/*if (lineCount == lastResizedLineCount) {
				return;
			}*/
			lastResizedLineCount = lineCount;

			const configuration = editor.getConfiguration();
			const lineHeight = configuration.lineHeight;
			const contentHeight = lineHeight * lineCount;

			const horizontalScrollbarHeight = configuration.layoutInfo.horizontalScrollbarHeight;
			const height = contentHeight + horizontalScrollbarHeight - 10;
			//const width = editor.getValue().length * 7 + 30;
			var width = 0;
			/*if ($(".view-line > span")[0] == undefined) {*/
				width = editor.getValue().length * 7 + 30;
			/*} else {
				width = $(".view-line > span")[0].getBoundingClientRect().width + 30;
			}*/
			//console.log("WIDTH " + width);

			editorElement.style.height = `${height}px`;
			editor.layout({
				height,
				//width: this.getElement().clientWidth,
				//width: editorElement.clientWidth,
				// Here we could make it depends on content
				width: width
			});
		}

		model.onDidChangeContent(() => {
			console.log("content changed");
			editorUpdate();
		});

		editorUpdate();
	}

	require.config({ paths: { 'vs': 'node_modules/monaco-editor/min/vs' }});

	require(['vs/editor/editor.main'], function() {
		monaco.languages.register({ id: 'calc' });

		monaco.languages.setTokensProvider('calc', new CalcTokensProvider.CalcTokensProvider());

		let literalFg = '3b8737';
		let idFg = '344482';
		let symbolsFg = '000000';
		let keywordFg = '7132a8';
		let errorFg = 'ff0000';

		monaco.editor.defineTheme('myCoolTheme', {
			base: 'vs',
			inherit: false,
			rules: [
				{ token: 'number_lit.calc',   foreground: literalFg },

				{ token: 'id.calc',           foreground: idFg,       fontStyle: 'italic' },

				{ token: 'lparen.calc',       foreground: symbolsFg },
				{ token: 'rparen.calc',       foreground: symbolsFg },

				{ token: 'equal.calc',        foreground: symbolsFg },
				{ token: 'minus.calc',        foreground: symbolsFg },
				{ token: 'plus.calc',         foreground: symbolsFg },
				{ token: 'div.calc',          foreground: symbolsFg },
				{ token: 'mul.calc',          foreground: symbolsFg },

				{ token: 'input_kw.calc',     foreground: keywordFg,  fontStyle: 'bold' },
				{ token: 'output_kw.calc',    foreground: keywordFg,  fontStyle: 'bold' },

				{ token: 'unrecognized.calc', foreground: errorFg }
			]
		});

		/*let editor = monaco.editor.create(document.getElementById('container'), {
			value: [
				'input salary',
				'input nEmployees',
				'input revenues',
				'input otherExpenses',
				'input taxRate',
				'',
				'totalExpenses = salary * nEmployees + otherExpenses',
				'grossProfit = revenues - totalExpenses',
				'totalTaxes = grossProfit * (taxRate / 100)',
				'profit = profit - totalTaxes',
				'',
				'output totalTaxes',
				'output profit',
				''
			].join('\n'),
			language: 'calc',
			theme: 'myCoolTheme'
		});
		editor.onDidChangeModelContent(function (e) {
			let code = editor.getValue()
			let syntaxErrors = ParserFacade.validate(code);
			let monacoErrors = [];
			for (let e of syntaxErrors) {
				monacoErrors.push({
					startLineNumber: e.startLine,
					startColumn: e.startCol,
					endLineNumber: e.endLine,
					endColumn: e.endCol,
					message: e.message,
					severity: monaco.MarkerSeverity.Error
				});
			};
			window.syntaxErrors = syntaxErrors;
			let model = monaco.editor.getModels()[0];
			monaco.editor.setModelMarkers(model, "owner", monacoErrors);
		});*/

		addInput('salary', 50000);
		addInput('nEmployees', 3);
		addInput('revenues', 437000);
		addInput('otherExpenses', 23000);
		addInput('taxRate', 42);

		addCalculation('totalExpenses', 'salary * nEmployees + otherExpenses');
		addCalculation('grossProfit', 'revenues - totalExpenses');
		addCalculation('totalTaxes', 'grossProfit * (taxRate / 100)');
		addCalculation('profit', 'grossProfit - totalTaxes');

		window.updater();

		$("#inputs .input input").change(function(){
			window.updater();
		});

		$(".collapsible").click(function() {
			$(this).siblings(".section-content").toggleClass("expanded");
		});

		function addType() {
			$("#types").siblings(".empty-message").hide();
			$("#types").append("<div class='type-definition'><input class='keyword' value='type'> <input class='editable' value='My type' required> <input class='keyword' value='{'/>"
					+"<div class='fields'><span class='message'>no fields</span><br><div class='fields-container'></div></div><span class='keyword'>}</span></div>");
			prepareInputs();
			$(".add-field-button").click(function () {
				$(this).siblings(".message").hide();
				console.log("add field");
			});
		}

		$("#add-type-button").click(function () {
			addType();
		});


		$.fn.textWidth = function(_text, _font){
			var textToConsider = _text || this.val();
			if (textToConsider == "") {
				textToConsider = this[0].placeholder;
			}
			var fakeEl = $('<span>').hide().appendTo(document.body).text(textToConsider).css({font: _font || this.css('font'), whiteSpace: "pre"}),
					width = fakeEl.width();
			fakeEl.remove();
			return width;
		};

		$.fn.inputWidthUpdate = function(options) {
			options = $.extend({padding:10,minWidth:0,maxWidth:10000}, options||{});
			$(this).css('width', Math.min(options.maxWidth,Math.max(options.minWidth,$(this).textWidth() + options.padding)));
		};

		$.fn.autoresize = function(options){//resizes elements based on content size.  usage: $('input').autoresize({padding:10,minWidth:0,maxWidth:100});
			$(this).on('input', function() {
				$(this).inputWidthUpdate(options);
			}).trigger('input');
			return this;
		};

		let myAutoresizeOptions = {padding:2,minWidth:10,maxWidth:300};

		function installAutoresize() {
			$("input").autoresize(myAutoresizeOptions);
		}

		function moveToPrevElement(t) {
			$(t).prev().focus();
			let text = $(t).prev().val();
			let el = $(t).prev()[0];
			if (el != undefined && el != null) {
				el.setSelectionRange(text.length, text.length);
			}
		}

		function moveToNextElement(t) {
			$(t).next().focus();
			let el = $(t).next()[0];
			if (el != undefined && el.setSelectionRange != null) {
				el.setSelectionRange(0, 0);
			}
		}

		function tryToAdd(t) {
			console.log("ADDING");
			window.t = t;
			$(t).siblings(".fields").find(".message").hide();
			$(t).siblings(".fields").append("<div class='field'><input class='keyword' value='field'><input class='editable' value='my field'></div>")
			prepareInputs();
		}

		function prepareInputs() {
			installAutoresize();
			$("input.keyword").on('keydown', function (e) {
				if (e.key == "ArrowRight") {
					e.preventDefault();
					moveToNextElement(this);
					return true;
				} else if (e.key == "ArrowLeft") {
					e.preventDefault();
					moveToPrevElement(this);
					return true;
				} else if (e.key == "Enter") {
					e.preventDefault();
					tryToAdd(this);
					return true;
				}
			});
			$("input.editable").on('keydown', function (e) {
				if (e.key == "ArrowRight") {
					console.log("RIGHT " + this.selectionStart);
					if (this.selectionStart == $(this).val().length) {
						e.preventDefault();
						moveToNextElement(this);
						return true;
					}
				} else if (e.key == "ArrowLeft") {
					console.log("LEFT");
					if (this.selectionStart == 0) {
						e.preventDefault();
						moveToPrevElement(this);
						return true;
					}
				} else if (e.key == "Enter") {
					e.preventDefault();
					tryToAdd(this);
					return true;
				} else {
					//console.log("K " + e.key);
				}
			});
		}



	});
</script>
</body>
</html>
